# Description: Network Sniffer
# URL:         https://www.wireshark.org/
# Depends on:  asciidoctor c-ares gnutls hicolor-icon-theme libcap libgcrypt libnl libpcap libssh qt5 speexdsp

name=wireshark
version=4.6.1
release=1
source=https://github.com/$name/$name/archive/v$version/$name-$version.tar.gz

build() {
	#if pkgman isinst gnutls >/dev/null 2>&1; then
	#	cmake_flags="$cmake_flags -D ENABLE_GNUTLS=ON"
	#fi

	#if pkgman isinst sbc >/dev/null 2>&1; then
	#	cmake_flags="$cmake_flags -D ENABLE_SBC=ON"
	#fi

	#if pkgman isinst opus >/dev/null 2>&1; then
	#	cmake_flags="$cmake_flags -D ENABLE_OPUS=ON"
	#fi

	# Enable ccache if present
	if pkgman isinst ccache >/dev/null 2>&1; then
		_cmake_flags="-D ENABLE_CCACHE=ON"
		PATH="$(echo $PATH | awk -v RS=: -v ORS=: '/ccache/ {next} {print}' | sed 's/:*$//')"
	fi

	cmake -S $name-$version -B build -G Ninja \
		-D CMAKE_INSTALL_PREFIX=/usr \
		-D CMAKE_INSTALL_LIBDIR=lib \
		-D CMAKE_INSTALL_LIBEXECDIR=/usr/lib \
		-D CMAKE_BUILD_TYPE=Release \
		-D CMAKE_C_FLAGS_RELEASE="$CFLAGS" \
		-D CMAKE_CXX_FLAGS_RELEASE="$CXXFLAGS" \
		-D ENABLE_OPUS=OFF \
		-D ENABLE_SBC=OFF \
		-D ENABLE_KERBEROS=OFF \
		-D USE_qt6=OFF \
		${_cmake_flags:+$_cmake_flags}

	ninja -C build -j ${JOBS:-1} -v
	DESTDIR=$PKG ninja -C build install

	# Grant capture perms to wheel group
	chmod 0750 $PKG/usr/bin/dumpcap
	chown root:wheel $PKG/usr/bin/dumpcap
	setcap cap_net_raw,cap_net_admin+eip $PKG/usr/bin/dumpcap

	# Strip localized desktop junk
	sed -ri '/\[.+\]=/d' $PKG/usr/share/applications/*.desktop

	# These files are read by wireshark's about box
	#rm -f $PKG/usr/share/$name/AUTHORS-SHORT
	#rm -f $PKG/usr/share/$name/COPYING

	# These files are used by Help menu
	#rm -r $PKG/usr/share/doc

	# Drop freedesktop appstream noise
	rm -r $PKG/usr/share/metainfo
}
